<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HouseLink ‚Äî Polished Edition</title>

  <!-- Tailwind for styling (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React (UMD) + Router + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-router-dom@5/umd/react-router-dom.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    /* small polish */
    html,body,#root { height: 100%; }
    .bg-soft { background: linear-gradient(180deg,#f8fafc 0%, #eef2f7 100%); }
  </style>
</head>
<body class="bg-soft text-slate-800">
  <div id="root"></div>

  <script type="text/babel">
  const { useState, useEffect, useMemo, useRef } = React;
  const { HashRouter, Switch, Route, Link, useParams, useHistory } = ReactRouterDOM;

  // -------------------- Utilities --------------------
  const store = {
    save(k,v){ localStorage.setItem(k, JSON.stringify(v)); },
    load(k, fallback){ try{ const v = JSON.parse(localStorage.getItem(k)); return v ?? fallback; }catch(e){ return fallback; } }
  };

  const currency = (v) => Number(v).toLocaleString();

  // -------------------- Seed Data --------------------
  const ADMIN = { id: 'admin', username: 'Admin', email: 'admin@gmail.com', password: '1234', role: 'admin', verified: true };
  const seedUsers = [ ADMIN ];

  const seedListings = [
    { id: 1, ownerId: 'admin', ownerRole: 'admin', title: 'Sunny Bedsitter', location: 'Sinza', price: 120000, images:['https://placehold.co/1200x800/orange/white?text=Sinza+Vibes'], description: 'A bright, cozy bedsitter perfect for students.', tags:['student-friendly'], amenities:['water','electricity'], reviews:[], createdAt:'2025-10-01', verified:true },
    { id: 2, ownerId: 'admin', ownerRole: 'admin', title: 'Modern Room', location: 'Mbezi', price: 80000, images:['https://placehold.co/1200x800/0d9488/white?text=Mbezi+Room'], description: 'Cool breeze, tile floors, near the bus stop.', tags:['near-bus'], amenities:['balcony'], reviews:[], createdAt:'2025-09-15', verified:false }
  ];

  // initialize storage defaults
  if(!localStorage.getItem('hl_users')) store.save('hl_users', seedUsers);
  if(!localStorage.getItem('hl_listings')) store.save('hl_listings', seedListings);

  // -------------------- Auth helpers --------------------
  function loadUsers(){ return store.load('hl_users', seedUsers); }
  function saveUsers(u){ store.save('hl_users', u); }
  function createUser({username,email,password,role='seller'}){
    const users = loadUsers();
    if(users.some(x=>x.username.toLowerCase()===username.toLowerCase())) return { error: 'Username already taken' };
    const id = 'u_'+Date.now();
    const user = { id, username, email, password, role, verified: false };
    users.push(user); saveUsers(users); return { user };
  }
  function findUserByCreds(username,password){ return loadUsers().find(u => (u.username===username || u.email===username) && u.password===password) || null; }

  // -------------------- Listing helpers --------------------
  function loadListings(){ return store.load('hl_listings', seedListings); }
  function saveListings(v){ store.save('hl_listings', v); }

  // -------------------- App components --------------------

  function Nav({currentUser, onLogout, openLogin}){
    return (
      <header className="bg-gradient-to-r from-teal-600 to-emerald-500 text-white sticky top-0 z-40">
        <div className="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
          <Link to="/" className="flex items-center gap-2 font-extrabold text-lg">üè† HouseLink</Link>
          <div className="flex items-center gap-3">
            <Link to="/listings" className="hidden sm:inline px-3 py-2 rounded hover:bg-white/10">Listings</Link>
            <Link to="/analytics" className="hidden sm:inline px-3 py-2 rounded hover:bg-white/10">Analytics</Link>
            {currentUser ? (
              <>
                <span className="hidden sm:inline">{currentUser.username} ({currentUser.role})</span>
                <Link to="/upload" className="px-3 py-2 bg-white text-teal-600 rounded font-bold">+ Upload</Link>
                <button onClick={onLogout} className="px-3 py-2 bg-red-100 text-red-700 rounded">Logout</button>
              </>
            ) : (
              <>
                <button onClick={openLogin} className="px-3 py-2 bg-white text-teal-600 rounded font-bold">Login</button>
                <Link to="/signup" className="px-3 py-2">Sign up</Link>
              </>
            )}
          </div>
        </div>
      </header>
    );
  }

  function Home(){
    return (
      <section className="max-w-6xl mx-auto p-6 text-center">
        <h1 className="text-4xl font-extrabold">Find your next home in Tanzania</h1>
        <p className="mt-3 text-slate-600">Search, save, schedule viewings, and manage your seller/broker listings ‚Äî local-first, offline-friendly.</p>
        <div className="mt-6 flex justify-center gap-3">
          <Link to="/listings" className="px-6 py-3 bg-teal-600 text-white rounded">Browse Listings</Link>
          <Link to="/upload" className="px-6 py-3 bg-white text-teal-600 rounded">List a Property</Link>
        </div>
      </section>
    );
  }

  function ListingsPage({currentUser}){
    const [listings,setListings] = useState(loadListings());
    const [q,setQ] = useState('');
    const [filter,setFilter] = useState('all');
    const [sort,setSort] = useState('newest');
    const [page,setPage] = useState(1);
    const perPage = 6;
    useEffect(()=> saveListings(listings), [listings]);

    const tags = useMemo(()=> Array.from(new Set(listings.flatMap(l=>l.tags||[]))), [listings]);

    let out = listings.filter(l=> {
      if(filter!=='all' && !(l.tags||[]).includes(filter)) return false;
      if(!q) return true;
      return (l.title + ' ' + l.location + ' ' + l.description).toLowerCase().includes(q.toLowerCase());
    });

    out = out.sort((a,b)=>{
      if(sort==='newest') return new Date(b.createdAt) - new Date(a.createdAt);
      if(sort==='price_low') return a.price - b.price;
      if(sort==='price_high') return b.price - a.price;
      return 0;
    });

    const pages = Math.max(1, Math.ceil(out.length / perPage));
    const pageItems = out.slice((page-1)*perPage, page*perPage);

    function toggleFav(id){
      const favs = store.load('hl_favs', []);
      const idx = favs.indexOf(id);
      if(idx>=0) { favs.splice(idx,1); } else { favs.push(id); }
      store.save('hl_favs', favs);
      // trigger re-render
      setListings([...loadListings()]);
    }

    return (
      <div className="max-w-6xl mx-auto p-6">
        <div className="bg-white p-4 rounded-lg shadow flex gap-3 items-center mb-6">
          <input value={q} onChange={e=>{ setQ(e.target.value); setPage(1); }} placeholder="Search title, location or description" className="flex-1 px-4 py-2 border rounded" />
          <select value={filter} onChange={e=>{ setFilter(e.target.value); setPage(1); }} className="px-3 py-2 border rounded">
            <option value="all">All Tags</option>
            {tags.map(t=> <option key={t} value={t}>{t}</option>)}
          </select>
          <select value={sort} onChange={e=>setSort(e.target.value)} className="px-3 py-2 border rounded">
            <option value="newest">Newest</option>
            <option value="price_low">Price: Low to High</option>
            <option value="price_high">Price: High to Low</option>
          </select>
        </div>

        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
          {pageItems.map(l => (
            <article key={l.id} className="bg-white rounded-2xl shadow overflow-hidden">
              <div className="relative h-44">
                <img src={l.images?.[0]||'https://placehold.co/1200x800?text=No+Image'} alt="" className="w-full h-full object-cover" />
                <div className="absolute top-3 left-3 bg-white/90 px-3 py-1 rounded-full text-sm font-bold text-teal-700">{l.location}</div>
                {l.ownerRole==='broker' && <div className="absolute top-3 right-3 bg-yellow-300 px-2 py-1 rounded-full text-xs font-bold">Broker</div>}
              </div>
              <div className="p-4 flex flex-col gap-3">
                <h3 className="font-bold text-lg">{l.title}</h3>
                <p className="text-sm text-slate-600 line-clamp-3">{l.description}</p>
                <div className="flex items-center justify-between">
                  <div>
                    <div className="text-orange-500 font-extrabold">{currency(l.price)} TZS</div>
                    <div className="text-xs text-slate-400">/ month</div>
                  </div>
                  <div className="flex gap-2">
                    <button onClick={()=>{ toggleFav(l.id); }} className="px-3 py-2 rounded bg-gray-100">‚ô°</button>
                    <Link to={"/listing/"+l.id} className="px-3 py-2 bg-teal-600 text-white rounded">View</Link>
                  </div>
                </div>
              </div>
            </article>
          ))}
        </div>

        <div className="flex justify-center items-center gap-4 mt-6">
          <button disabled={page===1} onClick={()=>setPage(p=>Math.max(1,p-1))} className="px-4 py-2 bg-gray-100 rounded">Prev</button>
          <div>Page {page} of {pages}</div>
          <button disabled={page===pages} onClick={()=>setPage(p=>Math.min(p+1,pages))} className="px-4 py-2 bg-gray-100 rounded">Next</button>
        </div>

      </div>
    );
  }

  function ListingView({ currentUser }){
    const { id } = useParams();
    const history = useHistory();
    const [listings,setListings] = useState(loadListings());
    const listing = listings.find(l => String(l.id) === String(id));
    if(!listing) return <div className="p-6">Listing not found.</div>;
    const isOwner = currentUser && (currentUser.id === listing.ownerId || currentUser.role === 'admin');

    function handleDelete(){ if(!confirm('Delete this listing?')) return; const updated = listings.filter(l=>l.id!==listing.id); saveListings(updated); history.push('/listings'); }

    function handleSchedule(){ const d = prompt('Enter viewing date (YYYY-MM-DD)'); if(d) alert('Viewing requested for '+d+' ‚Äî owner will be notified.'); }

    return (
      <div className="max-w-4xl mx-auto p-6">
        <div className="bg-white rounded-2xl shadow overflow-hidden">
          <div className="md:flex">
            <div className="md:w-1/2 p-4">
              <img src={listing.images?.[0]||'https://placehold.co/1200x800?text=No+Image'} alt="" className="w-full h-72 object-cover rounded" />
              <div className="mt-3 flex gap-2">{(listing.images||[]).map((i,idx)=> <img key={idx} src={i} className="w-20 h-16 object-cover rounded" />)}</div>
            </div>
            <div className="md:w-1/2 p-6 flex flex-col">
              <div className="flex justify-between items-start">
                <div>
                  <h2 className="text-2xl font-bold">{listing.title}</h2>
                  <div className="text-sm text-slate-500">{listing.location} ‚Ä¢ Posted {listing.createdAt}</div>
                </div>
                <div className="text-right">
                  <div className="text-orange-500 text-3xl font-extrabold">{currency(listing.price)}</div>
                  <div className="text-xs text-slate-400">/ month</div>
                </div>
              </div>

              <p className="mt-4 text-slate-600">{listing.description}</p>

              <div className="mt-4 flex gap-3">
                <button onClick={()=>navigator.clipboard?.writeText(location.href)} className="px-4 py-2 bg-gray-100 rounded">Copy Link</button>
                <button onClick={handleSchedule} className="px-4 py-2 bg-teal-600 text-white rounded">Schedule Viewing</button>
                {isOwner && <Link to={"/listing/"+listing.id+"/update"} className="px-4 py-2 bg-white border rounded">Edit</Link>}
                {isOwner && <button onClick={handleDelete} className="px-4 py-2 bg-red-100 text-red-700 rounded">Delete</button>}
              </div>

              <div className="mt-4">
                <h4 className="font-bold">Amenities</h4>
                <div className="flex gap-2 mt-2 flex-wrap">{(listing.amenities||[]).map(a=> <span key={a} className="px-3 py-1 bg-gray-100 rounded text-sm">{a}</span>)}</div>
              </div>

              <div className="mt-4">
                <h4 className="font-bold">Reviews</h4>
                <div className="mt-2 space-y-2">{(listing.reviews||[]).map((r,i)=> <div key={i} className="text-sm"><strong>{r.user}</strong> ‚Äî {Array(r.rating).fill('‚òÖ').join('')}<div>{r.comment}</div></div>)}</div>
              </div>

            </div>
          </div>
        </div>
      </div>
    );
  }

  function UploadPage({ currentUser }){
    const history = useHistory();
    const [form, setForm] = useState({ title:'', location:'', price:'', images:[''], description:'', tags:[], amenities:[] });
    function setField(k,v){ setForm(f=>({...f,[k]:v})); }

    function submit(e){ e.preventDefault(); if(!currentUser){ alert('Please login to create a listing'); history.push('/'); return; }
      const listings = loadListings(); const id = Date.now(); const newL = { ...form, id, ownerId: currentUser.id, ownerRole: currentUser.role || 'seller', createdAt: new Date().toISOString().slice(0,10), reviews:[], verified: false };
      listings.unshift(newL); saveListings(listings); history.push('/listings');
    }

    return (
      <div className="max-w-2xl mx-auto p-6">
        <div className="bg-white p-6 rounded shadow">
          <h3 className="text-xl font-bold mb-4">List a Property</h3>
          <form onSubmit={submit} className="space-y-3">
            <input placeholder="Title" value={form.title} onChange={e=>setField('title', e.target.value)} required />
            <div className="grid grid-cols-2 gap-2"><input placeholder="Location" value={form.location} onChange={e=>setField('location', e.target.value)} required /><input placeholder="Price (TZS)" type="number" value={form.price} onChange={e=>setField('price', e.target.value)} required /></div>
            <input placeholder="Image URL" value={form.images[0]} onChange={e=>setField('images', [e.target.value])} />
            <textarea placeholder="Description" value={form.description} onChange={e=>setField('description', e.target.value)} rows={4} />
            <div className="flex gap-2"><button type="button" onClick={()=>{ const t = prompt('Enter tag'); if(t) setField('tags', [...form.tags, t]); }} className="px-3 py-2 bg-gray-100 rounded">Add Tag</button><button type="button" onClick={()=>{ const a = prompt('Enter amenity'); if(a) setField('amenities', [...form.amenities, a]); }} className="px-3 py-2 bg-gray-100 rounded">Add Amenity</button></div>
            <div className="flex gap-2"><button className="px-4 py-2 bg-teal-600 text-white rounded">Publish</button><Link to="/listings" className="px-4 py-2 bg-gray-100 rounded">Cancel</Link></div>
          </form>
        </div>
      </div>
    );
  }

  function UpdateListing({ currentUser }){
    const { id } = useParams(); const history = useHistory(); const [listings,setListings] = useState(loadListings());
    const listing = listings.find(l=>String(l.id)===String(id)); if(!listing) return <div className="p-6">Not found</div>;
    if(!currentUser || (currentUser.id !== listing.ownerId && currentUser.role !== 'admin')) return <div className="p-6">Not authorized</div>;

    const [form,setForm] = useState({...listing});
    function submit(e){ e.preventDefault(); const updated = listings.map(l=> l.id===listing.id ? form : l); saveListings(updated); history.push('/listing/'+listing.id); }

    return (
      <div className="max-w-2xl mx-auto p-6">
        <div className="bg-white p-6 rounded shadow">
          <h3 className="text-xl font-bold mb-4">Edit Listing</h3>
          <form onSubmit={submit} className="space-y-3">
            <input value={form.title} onChange={e=>setForm({...form,title:e.target.value})} />
            <input value={form.location} onChange={e=>setForm({...form,location:e.target.value})} />
            <input value={form.price} type="number" onChange={e=>setForm({...form,price:Number(e.target.value)})} />
            <textarea value={form.description} onChange={e=>setForm({...form,description:e.target.value})} rows={4} />
            <div className="flex gap-2"><button className="px-4 py-2 bg-teal-600 text-white rounded">Save</button><Link to={'/listing/'+listing.id} className="px-4 py-2 bg-gray-100 rounded">Cancel</Link></div>
          </form>
        </div>
      </div>
    );
  }

  function AnalyticsPage({ currentUser }){
    if(!currentUser) return <div className="p-6">Please login to view analytics.</div>;
    const listings = loadListings(); const my = listings.filter(l=> l.ownerId === currentUser.id);
    return (
      <div className="max-w-4xl mx-auto p-6">
        <h3 className="text-xl font-bold mb-4">Seller Dashboard</h3>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div className="bg-white p-4 rounded shadow">Your listings: <strong>{my.length}</strong></div>
          <div className="bg-white p-4 rounded shadow">Total simulated views: <strong>{my.length*42 + 18}</strong></div>
        </div>
        <div className="mt-4 bg-white p-4 rounded shadow">Tip: Verified listings get higher visibility. Admin can toggle verification in listings.</div>
      </div>
    );
  }

  // -------------------- Authentication Modal + Signup/Login --------------------
  function AuthModal({ open, onClose, onLogin }){
    const [mode,setMode] = useState('login');
    const [u,setU] = useState(''); const [p,setP] = useState(''); const [email,setEmail] = useState('');

    function doLogin(){ const user = findUserByCreds(u,p); if(!user){ alert('Wrong credentials'); return; } onLogin(user); onClose(); }
    function doSignup(){ if(!u||!email||!p){ alert('Fill all'); return; } if(!email.endsWith('@gmail.com')){ alert('Please use a Gmail address'); return; } const res = createUser({username:u,email,password:p}); if(res.error){ alert(res.error); return; } alert('Account created, you can login now'); setMode('login'); }

    if(!open) return null;
    return (
      <div className="fixed inset-0 bg-black/30 flex items-center justify-center z-50">
        <div className="bg-white p-6 rounded shadow max-w-md w-full">
          <div className="flex justify-between items-center mb-4">
            <h4 className="font-bold">{mode==='login' ? 'Login' : 'Sign up'}</h4>
            <button onClick={onClose} className="text-slate-500">Close</button>
          </div>
          {mode==='login' ? (
            <div className="space-y-2">
              <input placeholder="Username or Gmail" value={u} onChange={e=>setU(e.target.value)} />
              <input placeholder="Password" type="password" value={p} onChange={e=>setP(e.target.value)} />
              <div className="flex gap-2"><button onClick={doLogin} className="px-4 py-2 bg-teal-600 text-white rounded">Login</button><button onClick={()=>setMode('signup')} className="px-4 py-2 bg-gray-100 rounded">Create account</button></div>
            </div>
          ) : (
            <div className="space-y-2">
              <input placeholder="Username" value={u} onChange={e=>setU(e.target.value)} />
              <input placeholder="Gmail (must be @gmail.com)" value={email} onChange={e=>setEmail(e.target.value)} />
              <input placeholder="Password" type="password" value={p} onChange={e=>setP(e.target.value)} />
              <div className="flex gap-2"><button onClick={doSignup} className="px-4 py-2 bg-teal-600 text-white rounded">Sign up</button><button onClick={()=>setMode('login')} className="px-4 py-2 bg-gray-100 rounded">Back to login</button></div>
            </div>
          )}
        </div>
      </div>
    );
  }

  // -------------------- App --------------------
  function App(){
    const [currentUser,setCurrentUser] = useState(store.load('hl_current_user', null));
    const [loginOpen,setLoginOpen] = useState(false);

    useEffect(()=> store.save('hl_current_user', currentUser), [currentUser]);

    function handleLogout(){ setCurrentUser(null); store.save('hl_current_user', null); }

    return (
      <HashRouter>
        <Nav currentUser={currentUser} onLogout={handleLogout} openLogin={()=>setLoginOpen(true)} />

        <AuthModal open={loginOpen} onClose={()=>setLoginOpen(false)} onLogin={(u)=>{ setCurrentUser(u); }} />

        <Switch>
          <Route exact path="/">
            <Home />
          </Route>

          <Route path="/listings">
            <ListingsPage currentUser={currentUser} />
          </Route>

          <Route exact path="/listing/:id">
            <ListingView currentUser={currentUser} />
          </Route>

          <Route exact path="/listing/:id/update">
            <UpdateListing currentUser={currentUser} />
          </Route>

          <Route path="/upload">
            <UploadPage currentUser={currentUser} />
          </Route>

          <Route path="/analytics">
            <AnalyticsPage currentUser={currentUser} />
          </Route>

          <Route path="/signup">
            <div className="max-w-md mx-auto p-6"><AuthModal open={true} onClose={()=>{ window.location.hash = '#/'; }} onLogin={(u)=>{ setCurrentUser(u); window.location.hash = '#/'; }} /></div>
          </Route>

          <Route>
            <div className="p-6">Page not found</div>
          </Route>
        </Switch>

        <footer className="mt-8 p-6 text-center text-slate-500">HouseLink ‚Äî local demo ‚Ä¢ Data persisted to localStorage</footer>
      </HashRouter>
    );
  }

  ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
